<template>
  <div id="section-request" class="container-fluid row my-4">
    <!-- SUCCESSFUL_SUBMISSION_MESSAGE -->
    <div class="container-fluid" v-if="submission">
      <div class="alert alert-success" role="alert">
        Thank you! Your request has been successfully sent.
      </div>
    </div>
    <!-- SUBMISSION_FORM -->
    <form
      class="needs-validation"
      @submit.prevent="handleSubmit"
      v-else-if="!submission"
    >
      <h1>New Request</h1>
      <div class="infos form-group my-3">
        <Info
          ><h2>Fulfilled:</h2>
          <p class="red">
            {{ fulfilledCount }}<i class="fa-solid fa-heart fa-xs"></i>
          </p>
        </Info>
        <Info
          ><h2>Pending:</h2>
          <p>{{ pendingCount }}<i class="fa-solid fa-heart-crack fa-xs"></i></p>
        </Info>
      </div>

      <!-- NAME -->
      <div class="form-group mb-3">
        <label class="form-label" for="title">Name:</label>
        <input
          class="form-control"
          :class="{ 'is-invalid': v$.name.$errors.length }"
          @blur="v$.name.$touch"
          type="text"
          name="name"
          v-model="name"
          required
          placeholder="First and Last"
        />
        <div class="invalid-feedback">Please provide your full name.</div>
      </div>

      <!-- EMAIL -->
      <div class="form-group mb-3">
        <label class="form-label" for="email">Email:</label>
        <input
          class="form-control"
          :class="{ 'is-invalid': v$.email.$errors.length }"
          @blur="v$.email.$touch"
          type="email"
          name="email"
          v-model="email"
          required
        />
        <div class="invalid-feedback">
          Please provide a valid email address.
        </div>
      </div>

      <!-- PHONE -->
      <div class="form-group mb-3">
        <label class="form-label" for="phone">Phone Number:</label>
        <input
          class="form-control"
          :class="{ 'is-invalid': v$.phone.$errors.length }"
          @blur="v$.phone.$touch"
          type="tel"
          v-model="phone"
          v-maska="'(###) ###-####'"
          placeholder="(###) ###-####"
          maxlength="14"
          required
        />
        <div class="invalid-feedback">
          Please provide a valid telephone number.
        </div>
      </div>

      <!-- EMAIL -->
      <div class="form-group mb-3">
        <label class="form-label" for="request">Request:</label>
        <textarea
          class="form-control"
          :class="{ 'is-invalid': v$.request.$errors.length }"
          @blur="v$.request.$touch"
          name="request"
          v-model="request"
          rows="7"
          maxlength="500"
          required
          placeholder="500 chars max."
        ></textarea>
        <div class="invalid-feedback">Please provide a valid request.</div>
      </div>

      <button
        type="submit"
        class="btn btn-primary mb-3"
        :disabled="v$.$invalid"
      >
        <span>Submit</span>
        <svg viewBox="0 0 50 50" width="50" height="50">
          <path
            d="M48.8,22.9L3,0.2C1.6-0.5,0,0.6,0,2.3v18.8L30.4,25L0,28.9v18.8c0,1.7,1.6,2.8,3,2.1l45.8-22.7
	C50.4,26.3,50.4,23.7,48.8,22.9z"
          />
        </svg>
      </button>
    </form>
  </div>
</template>

<script>
import { useVuelidate } from "@vuelidate/core";
import { email, required } from "@vuelidate/validators";
//import { ref } from "vue";
//import { computed } from "vue";
import Info from "./Info";

// firebase imports
import { db } from "../firebase/config";
import { getDocs, addDoc, collection } from "firebase/firestore";

export default {
  components: { Info },
  data() {
    return {
      name: "",
      email: "",
      phone: "",
      request: "",
      submission: false,
      fulfilledCount: 0,
      pendingCount: 0,
    };
  },
  setup() {
    return {
      v$: useVuelidate(),
    };
  },
  mounted() {
    const colRef = collection(db, "requests");
    let el = this;
    getDocs(colRef).then((snapshot) => {
      snapshot.docs.forEach((doc) => {
        if (doc.data().fulfilled) {
          el.fulfilledCount++;
        } else {
          el.pendingCount++;
        }
      });
    });
  },
  validations() {
    return {
      name: { required },
      email: { required, email },
      phone: { required },
      request: { required },
    };
  },
  methods: {
    async handleSubmit() {
      let form = document.querySelector(".needs-validation");
      form.checkValidity();

      // check for valid form
      const isFormGood2Go = await this.v$.$validate();
      if (!isFormGood2Go) {
        return;
      }

      form.classList.add("was-validated");

      const colRef = collection(db, "requests");

      await addDoc(colRef, {
        name: this.name,
        email: this.email,
        phone: this.phone,
        request: this.request,
        fulfilled: false,
      });
      this.resetForm();
      this.submission = true;
    },
    resetForm() {
      this.name = "";
      this.email = "";
      this.phone = "";
      this.request = "";
    },
  },
};
</script>

<style lang="scss" scoped>
.container,
.container-fluid,
.container-xxl,
.container-xl,
.container-lg,
.container-md,
.container-sm {
  padding: 0 !important;
  position: relative;
}

.infos {
  display: flex;
  flex-direction: row;
  justify-content: space-between;
  align-items: center;
  padding: 0;
  & h2 {
    padding: 20px 20px 0 20px;
    margin: 0;
    text-transform: uppercase;
    @media (min-width: 576px) {
      // RED (SM)
    }
    @media (min-width: 768px) {
      // GREEN (MD)
      padding: 20px;
    }
    @media (min-width: 992px) {
      // BLUE (LG)
    }
    @media (min-width: 1200px) {
      // YELLOW (XL)
    }
    @media (min-width: 1400px) {
      // PURPLE (XXL)
    }
  }
  & p {
    color: #45c3ff;
    font-size: 2rem;
    font-weight: 500;
    margin: 0;
    padding: 0 0 20px 0;
    @media (min-width: 576px) {
      // RED (SM)
    }
    @media (min-width: 768px) {
      // GREEN (MD)
      padding: 20px 20px 20px 0;
    }
    @media (min-width: 992px) {
      // BLUE (LG)
    }
    @media (min-width: 1200px) {
      // YELLOW (XL)
    }
    @media (min-width: 1400px) {
      // PURPLE (XXL)
    }
    &.red {
      color: red;
    }
  }
  & .fa-solid {
    margin-left: 5px;
  }
}
</style>
